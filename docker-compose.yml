services:
  wildlings:
    build: .
    ports:
      - '8000:8000'
    volumes:
      - wildlings-data:/data
    environment:
      - DATABASE_URL=sqlite:////data/wildlings.db
      - STATIC_DIR=/app/app/dist
      - CORS_ALLOW_ORIGINS=
      - INTERNAL_SYNC_TOKEN=
      - UVICORN_EXTRA_ARGS=--reload

    # NEW: Watch configuration
    develop:
      watch:
        # 1. Rebuild if configuration/dependencies change
        - action: rebuild
          path: ./api/pyproject.toml
        - action: rebuild
          path: ./api/uv.lock
        - action: rebuild
          path: ./app/package.json
        - action: rebuild
          path: ./app/package-lock.json
        - action: rebuild
          path: ./Dockerfile

        # 2. Frontend: REBUILD image on change (Runtime image has no Node/npm)
        - action: rebuild
          path: ./app
          ignore:
            - node_modules/
            - dist/
            - .tanstack/

        # 3. Backend: SYNC changes (Hot Reload works via uvicorn)
        - action: sync
          path: ./api
          target: /app/api
          ignore:
            - __pycache__/
            - '*.pyc'

    healthcheck:
      test:
        - CMD-SHELL
        - >-
          python -c "import os,urllib.request;req=urllib.request.Request('http://localhost:8000/sync/pull?cursor=',headers={'X-Internal-Token': os.getenv('INTERNAL_SYNC_TOKEN','')});urllib.request.urlopen(req,timeout=2).read()"
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

volumes:
  wildlings-data:
